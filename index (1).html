<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Popup Chaos Fixed</title>
<style>
  html,body { height:100%; margin:0; background:black; }
  #overlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:black; color:white; font-size:2rem; cursor:pointer;
  }
</style>
</head>
<body>
<div id="overlay">Click to start chaos</div>

<script>
let chaosStarted = false;
let popupWindows = [];
let audioCtx = null;

// In the main page script, after your other code:
let hasUnsavedChanges = true;
window.addEventListener("beforeunload", function (e) {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = ''; // triggers the browser's built‑in prompt
  }
});


// Main page effects
function startMainEffects() {
  try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
  setInterval(() => {
    document.body.style.backgroundColor =
      'hsl(' + Math.floor(Math.random()*360) + ',100%,50%)';
  }, 120);
  setInterval(() => {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.value = 300 + Math.random() * 900;
    gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.07);
    osc.connect(gain).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.08);
  }, 200);
}

// HTML for popup
const popupContent = `
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Chaos</title>
<style>html,body{margin:0;height:100%;}</style></head>
<body>
<script>
setInterval(() => {
  document.body.style.backgroundColor =
    'hsl(' + Math.floor(Math.random()*360) + ',100%,50%)';
}, 100);
setInterval(() => {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.value = 400 + Math.random()*800;
    gain.gain.setValueAtTime(0.05, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.06);
    osc.connect(gain).connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.07);
    osc.onended = () => ctx.close && ctx.close();
  } catch(e){}
}, 180);

// In the main page script, after your other code:
let hasUnsavedChanges = true;
window.addEventListener("beforeunload", function (e) {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = ''; // triggers the browser's built‑in prompt
  }
});


<\/script>
</body>
</html>
`;

// Spawn popup and inject immediately
function spawnPopup() {
  const width = 260, height = 180;
  const w = window.open('', '_blank', `width=${width},height=${height},left=150,top=150`);
  if (w) {
    w.document.open();
    w.document.write(popupContent);
    w.document.close();
    popupWindows.push(w);

    // Move quickly
    const moveInterval = setInterval(() => {
      if (w.closed) {
        clearInterval(moveInterval);
        return;
      }
      try {
        const x = Math.floor(Math.random() * Math.max(1, screen.availWidth - width));
        const y = Math.floor(Math.random() * Math.max(1, screen.availHeight - height));
        w.moveTo(x, y);
      } catch (err) {
        clearInterval(moveInterval);
      }
    }, 80);
  }
}

document.getElementById("overlay").addEventListener("click", () => {
  if (chaosStarted) return;
  chaosStarted = true;
  document.getElementById("overlay").style.display = "none";
  startMainEffects();
  spawnPopup();
  document.addEventListener("click", spawnPopup, { passive: true });
});

window.addEventListener("beforeunload", () => {
  popupWindows.forEach(w => { try { w.close(); } catch(e){} });
});
</script>
</body>
</html>
